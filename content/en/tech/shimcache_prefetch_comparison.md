---
date: 2026-01-24T09:00:00
draft: false
title: "Sysmon â†’ Prefetch â†’ ShimCache â†’ Amcache: å®Ÿè¡Œãƒã‚§ãƒ¼ãƒ³å¾©å…ƒ å®Ÿå‹™ã‚¬ã‚¤ãƒ‰ (LOLBAS ãƒ­ã‚°é€£æºå«ã‚€)"
description: "Sysmon Event ID 1ã‚’å‡ºç™ºç‚¹ã«Prefetchãƒ»ShimCacheãƒ»Amcacheã‚’äº¤å·®ã•ã›ã€ã€å®Ÿè¡Œã®æœ‰ç„¡ã€ã‹ã‚‰ã€å®Ÿè¡Œãƒã‚§ãƒ¼ãƒ³(Execution Chain)ã€ã¾ã§å¾©å…ƒã™ã‚‹å®Ÿå‹™ãƒ•ãƒ­ãƒ¼ã‚’æ•´ç†ã—ã¾ã™ã€‚(LOLBAS ãƒ­ã‚°é€£æºå«ã‚€)"
featured_image: "cdn/tech/shimcache_prefetch_comparison.png"
tags: ["Digital Forensics", "Sysmon", "Prefetch", "ShimCache", "Amcache", "Windows Event Log", "LOLBAS", "ä¾µå®³äº‹æ•…åˆ†æ", "Execution Chain", "æŒç¶šæ€§(Persistence)"]
---

ğŸ“Œ **ã“ã®è¨˜äº‹ã®ç›®çš„ã¯ä¸€ã¤ã§ã™ã€‚**  
ã€Œæ‚ªæ€§ãƒ•ã‚¡ã‚¤ãƒ«ãŒå®Ÿè¡Œã•ã‚ŒãŸã®ã‹ï¼Ÿã€ã§çµ‚ã‚ã‚‰ã›ãšã€ã•ã‚‰ã«ä¸€æ®µè¸ã¿è¾¼ã‚“ã§  
âœ… **ã€Œèª°ãŒ(è¦ª) â†’ ä½•ã‚’(å­) â†’ ã©ã‚“ãªå¼•æ•°(CommandLine)ã§ â†’ ã„ã¤å®Ÿè¡Œã—ã€ãã®å¾Œã«ä½•ã‚’ã—ãŸã®ã‹ï¼Ÿã€**  
ã¤ã¾ã‚Š **å®Ÿè¡Œãƒã‚§ãƒ¼ãƒ³**(Execution Chain) ã‚’ **å ±å‘Šæ›¸ã¨ã—ã¦æºã‚‹ãŒãªã„å½¢ã§** å¾©å…ƒã™ã‚‹ã“ã¨ã§ã™ã€‚

---

## 0) ãªãœã“ã®é †åºãŒã„ã¡ã°ã‚“è¦ªåˆ‡ãªã®ã‹ï¼Ÿ

ä¾µå®³äº‹æ•…åˆ†æã¯é€šå¸¸ã“ã®ã‚ˆã†ã«å§‹ã¾ã‚Šã¾ã™ã€‚

- ã€Œæ€ªã—ã„å®Ÿè¡ŒãŒã‚ã£ãŸæ°—ãŒã—ã¾ã™ãŒâ€¦ã€
- ã€Œã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ‚ªæ€§ã£ã½ã„ã§ã™ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã‹ï¼Ÿã€
- ã€ŒEDRãŒç„¡ã„ã€ã¾ãŸã¯ãƒ­ã‚°ãŒé€”ä¸­ã§é€”åˆ‡ã‚Œã¦ã„ã¾ã™â€¦ã€

ã“ã†ã„ã†ã¨ã **æœ€ã‚‚è¿·ã„ã«ãã„é †åº** ãŒã‚ã‚Šã¾ã™ã€‚

1) **Sysmon Event ID 1**: å®Ÿè¡Œãƒã‚§ãƒ¼ãƒ³ã®éª¨æ ¼(è¦ª-å­-ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³-ãƒãƒƒã‚·ãƒ¥)  
2) **Prefetch**: ã€Œæœ¬å½“ã«å®Ÿè¡Œã•ã‚ŒãŸã€ã‚’æœ€ã‚‚ç›´æ„Ÿçš„ã«ç¢ºè¨¼  
3) **ShimCache**: å®Ÿè¡ŒãŒæ›–æ˜§ã§ã‚‚ã€Œãã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãã®ãƒ‘ã‚¹ã«å­˜åœ¨ã—ãŸã€ã‚’å›ºå®š  
4) **Amcache**: ãƒ•ã‚¡ã‚¤ãƒ«åãŒå¤‰ã‚ã£ã¦ã‚‚ã€Œã“ã‚ŒãŒãã®ãƒ•ã‚¡ã‚¤ãƒ«ã€ã§ã‚ã‚‹ã“ã¨ã‚’(ãƒ¡ã‚¿/ãƒãƒƒã‚·ãƒ¥)ã§ç¢ºå®š  
5) (ã‚ã‚Œã°) **PowerShell/Task/WMIãƒ­ã‚°**ã§LOLBASãƒ»æŒç¶šæ€§ã¾ã§æ¥ç¶š  
6) æœ€å¾Œã« **ãƒ¬ãƒãƒ¼ãƒˆ**: æ™‚é–“/ãƒ‘ã‚¹/åŒä¸€æ€§/ãƒã‚§ãƒ¼ãƒ³æ ¹æ‹ ã‚’ã‚»ãƒƒãƒˆã§æç¤º

---

## 1) å®Ÿè¡Œãƒã‚§ãƒ¼ãƒ³å¾©å…ƒãƒ•ãƒ­ãƒ¼å›³ (Sysmon 1ç•ªã‹ã‚‰ãƒ¬ãƒãƒ¼ãƒˆã¾ã§ä¸€ç›´ç·š)

**Sysmon 1ç•ª â†’ ãƒ¬ãƒãƒ¼ãƒˆ** ã¾ã§ã‚’ã€Œé€”åˆ‡ã‚Œãšã«ã€1æšã§èª¬æ˜ã—ã¾ã™ã€‚

```mermaid
flowchart TD
  A[åˆ†æé–‹å§‹] --> B{Sysmon Event ID 1 ãƒ­ã‚°ã‚ã‚Š}

  B -->|Yes| C[Sysmon ID 1ã§éª¨æ ¼å›ºå®š]
  B -->|No| C2[Sysmonæ¬ è½ã‚’æƒ³å®š]

  C --> D[Prefetchç¢ºèª]
  C2 --> D

  D --> E{Prefetch pfå­˜åœ¨}
  E -->|Yes| F[å®Ÿè¡Œç¢ºå®š]
  E -->|No| F2[Prefetchä¸åœ¨ã®å¯èƒ½æ€§]

  F --> G[ShimCacheç¢ºèª]
  F2 --> G

  G --> H[Amcacheç¢ºèª]

  H --> I{è¿½åŠ ãƒ­ã‚°ã§æ‹¡å¼µå¯èƒ½}
  I -->|Yes| J[PowerShell Task WMI 4688 é€£æº]
  I -->|No| K[ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆäº¤å·®ã§æœ€å°å¾©å…ƒ]

  J --> L[æŒç¶šæ€§ç‚¹æ¤œ]
  K --> L

  L --> M[ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ•´ç†]
  M --> N[ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ\nãƒã‚§ãƒ¼ãƒ³ æ™‚é–“ ãƒ‘ã‚¹ åŒä¸€æ€§]
```

---

## 2) 1ç•ª(Sysmon Event ID 1)ã‹ã‚‰è¦‹ã‚‹ç†ç”±: ã€Œå®Ÿè¡Œãƒã‚§ãƒ¼ãƒ³ã®èƒŒéª¨ã€ã‚’å…ˆã«ç«‹ã¦ã‚‹

Sysmon **Event ID 1**(Process Create) ã¯æ–‡å­—é€šã‚Š  
ã€Œ**ãƒ—ãƒ­ã‚»ã‚¹ãŒç”Ÿæˆ(å®Ÿè¡Œ)ã•ã‚ŒãŸç¬é–“**ã€ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚

ã“ã“ã§é‡è¦ãªã®ã¯ã€SysmonãŒã‚ã‚Œã° **å®Ÿè¡Œãƒã‚§ãƒ¼ãƒ³ã‚’ã€å‹˜ã€ã§ã¯ãªãã€æ ¹æ‹ ã€ã§** æŸã­ã‚‰ã‚Œã‚‹ç‚¹ã§ã™ã€‚

### âœ… Sysmon ID 1ã§ç‰¹ã«é‡è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

* **ParentImage**: ã€Œèª°ãŒã“ã‚Œã‚’å®Ÿè¡Œã—ãŸã®ã‹ï¼Ÿã€
* **Image**: ã€Œä½•ãŒå®Ÿè¡Œã•ã‚ŒãŸã®ã‹(æ­£ç¢ºãªãƒ‘ã‚¹)ï¼Ÿã€
* **CommandLine**: ã€Œã©ã‚“ãªå¼•æ•°ã§å®Ÿè¡Œã•ã‚ŒãŸã®ã‹ï¼Ÿã€ (LOLBASã§ã¯ã»ã¼æ ¸å¿ƒ)
* **Hashes**: ã€Œã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæœ¬å½“ã«ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ï¼Ÿã€ (åŒä¸€æ€§ç¢ºå®š)
* **Time**: ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®åŸºæº–ç‚¹

ğŸ“Œ ä¸€è¡Œè¦ç´„

> **Sysmon 1ç•ªã¯â€œãƒã‚§ãƒ¼ãƒ³â€ã‚’ä½œã‚Šã€  
> Prefetch/ShimCache/Amcacheã¯ãã®ãƒã‚§ãƒ¼ãƒ³ã‚’â€œæºã‚‹ãŒãªã„ã‚ˆã†å›ºå®šã™ã‚‹â€ã€‚**

---

## 3) 2ç•ª(Prefetch)ã‚’çµ„ã¿åˆã‚ã›ã‚‹ç†ç”±: ã€Œå®Ÿè¡Œã•ã‚ŒãŸã€ã‚’æœ€ã‚‚ç›´æ„Ÿçš„ã«è£ä»˜ã‘ã‚‹

Prefetchã¯å…ƒã€… **å®Ÿè¡Œé€Ÿåº¦æœ€é©åŒ–** æ©Ÿèƒ½ã§ã™ãŒã€ãƒ•ã‚©ãƒ¬ãƒ³ã‚¸ãƒƒã‚¯ã§ã¯å˜ç´”ã§ã™ã€‚

> `.pf` ãŒæ®‹ã£ã¦ã„ã‚Œã°ã€**ãã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯å®Ÿè¡Œã•ã‚ŒãŸå¯èƒ½æ€§ãŒéå¸¸ã«é«˜ã„** ã§ã™ã€‚

### âœ… PrefetchãŒä¸ãˆã‚‹å®Ÿå‹™çš„è¨¼æ‹ 3ç¨®

* **å®Ÿè¡Œæ™‚é–“(Last Run Time)**: ã€Œã„ã¤å®Ÿè¡Œã•ã‚ŒãŸã®ã‹ï¼Ÿã€
* **å®Ÿè¡Œå›æ•°(Run Count)**: ã€Œä½•å›å®Ÿè¡Œã•ã‚ŒãŸã®ã‹ï¼Ÿã€
* **å‚ç…§ç—•è·¡(ãƒ­ãƒ¼ãƒ‰/ã‚¢ã‚¯ã‚»ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹)**: ã€Œå®Ÿè¡Œä¸­ã«ä½•ã«è§¦ã‚ŒãŸã‹ï¼Ÿã€

### â— Prefetchå˜ç‹¬ã§çµ‚ãˆã‚‹ã¨æƒœã—ã„ç†ç”±

Prefetchã¯ã€Œå®Ÿè¡Œã€ã«ã¯å¼·ã„ã§ã™ãŒã€

* ã€Œèª°ãŒå®Ÿè¡Œã—ãŸã‹(è¦ªãƒ—ãƒ­ã‚»ã‚¹)ã€
* ã€Œæ­£ç¢ºãªã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã€  
  ã‚’ **å®Œå…¨ã«å¾©å…ƒã™ã‚‹ã®ã¯é›£ã—ã„** ã§ã™ã€‚

ãã®ãŸã‚ **Sysmon(è¦ª/ã‚³ãƒãƒ³ãƒ‰) â†” Prefetch(å®Ÿè¡Œè£ä»˜ã‘/æ™‚é–“/å›æ•°)** ã®çµ„ã¿åˆã‚ã›ãŒæœ€ã‚‚å®‰å®šã—ã¾ã™ã€‚

---

## 4) 3ç•ª(ShimCache)ã‚’è¦‹ã‚‹ç†ç”±: ã€Œãã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãã®ãƒ‘ã‚¹ã«å­˜åœ¨ã—ãŸã®ã¯ç¢ºå®Ÿã€ã§å›ºå®š

æ”»æ’ƒè€…ã¯ã‚ˆãæ¬¡ã®ã‚ˆã†ãªã“ã¨ã‚’è¡Œã„ã¾ã™ã€‚

* å®Ÿè¡Œå¾Œ **self-delete**
* ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•/åå‰å¤‰æ›´
* ç—•è·¡å‰Šé™¤ã®è©¦ã¿

ã“ã®ã¨ãShimCache(AppCompatCache)ã¯ã€Œå®Ÿè¡Œã®æœ‰ç„¡ã€ã‚ˆã‚Šã‚‚å…ˆã«ã€  
âœ… ã€Œ**ãã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚·ã‚¹ãƒ†ãƒ ã«å­˜åœ¨ã—ã¦ã„ãŸ**(ãƒ‘ã‚¹å«ã‚€)ã€ã“ã¨ã‚’å›ºå®šã™ã‚‹ã®ã«å¼·ã„ã§ã™ã€‚

### âŒ ShimCacheã§ã‚ˆãã‚ã‚‹èª¤è§£(é‡è¦)

* ShimCacheã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¯é€šå¸¸ **ã€å®Ÿè¡Œæ™‚åˆ»ã€ã§ã¯ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚**  
  (ç’°å¢ƒã«ã‚ˆã£ã¦ã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«æœ€çµ‚æ›´æ–°æ™‚åˆ»ã®æ€§è³ªã€ç­‰ã¨ã—ã¦è§£é‡ˆã™ã‚‹ã»ã†ãŒå®‰å…¨ãªå ´åˆãŒå¤šã„ã§ã™ã€‚)
* ã—ãŸãŒã£ã¦ShimCacheã ã‘ã§ã€Œã“ã®æ™‚é–“ã«å®Ÿè¡Œã•ã‚ŒãŸã€ã¨æ–­å®šã™ã‚‹ã¨ **ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãŒæ­ªã‚€æã‚ŒãŒã‚ã‚Šã¾ã™ã€‚**

ğŸ“Œ ShimCacheã¯ã“ã†ä½¿ã†ã¨ã¡ã‚‡ã†ã©è‰¯ã„ã§ã™

> **Prefetch/Sysmonã§å®Ÿè¡Œã‚’æ‰ãˆã€**  
> **ShimCacheã§å­˜åœ¨/ãƒ‘ã‚¹ã‚’é‡˜æ‰“ã¡ã™ã‚‹ã€‚**

---

## 5) 4ç•ª(Amcache)ã‚’æœ€å¾Œã«ä»˜ã‘ã‚‹ç†ç”±: ã€Œã“ã‚ŒãŒãã®ãƒ•ã‚¡ã‚¤ãƒ«ã€ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºå®šã™ã‚‹

Amcacheã¯å ´åˆã«ã‚ˆã£ã¦ **æ±ºå®šæ‰“** ã«ãªã‚Šã¾ã™ã€‚

* ãƒ•ã‚¡ã‚¤ãƒ«åãŒå¤‰ã‚ã£ã¦ã„ã¦ã‚‚
* ãƒ‘ã‚¹ãŒç§»å‹•ã—ã¦ã„ã¦ã‚‚
* å…ƒãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã¦ã‚‚

Amcacheã«æ®‹ã‚‹ **è­˜åˆ¥æƒ…å ±**(ãƒ¡ã‚¿/ãƒãƒƒã‚·ãƒ¥ç­‰)ã«ã‚ˆã‚Š  
âœ… ã€ŒåŒä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã€ã‹ã©ã†ã‹ã‚’ã€ã‚ˆã‚Šå¼·ãä¸»å¼µã§ãã¾ã™ã€‚

### âœ… AmcacheãŒç‰¹ã«è¼ãçŠ¶æ³

* IOC(ãƒãƒƒã‚·ãƒ¥)ã§ **åŒä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã‹ç¢ºå®š** ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã¨ã
* æ­£å¸¸ãƒ•ã‚¡ã‚¤ãƒ«ã«å½è£…ã—ã¦ã„ã¦ã‚‚ã€ãƒ¡ã‚¿/è­˜åˆ¥æƒ…å ±ã§ **å˜˜ã‚’å´©ã™** å¿…è¦ãŒã‚ã‚‹ã¨ã
* PrefetchãŒç„¡ã„/æ›–æ˜§ãªã¨ãã« **è£œå¼·æ ¹æ‹ ** ãŒå¿…è¦ãªã¨ã

---

## 6) ğŸ” ä¸€ç›®ã§æ¯”è¼ƒ: Sysmon Â· Prefetch Â· ShimCache Â· Amcache

| åŒºåˆ†     | Sysmon (Event ID 1) | Prefetch        | ShimCache       | Amcache          |
| ------ | ------------------- | --------------- | --------------- | ---------------- |
| ä¸€è¡Œå½¹å‰² | å®Ÿè¡Œãƒã‚§ãƒ¼ãƒ³ã€Œéª¨æ ¼ã€          | å®Ÿè¡Œã€Œç¢ºè¨¼ã€         | å­˜åœ¨/ãƒ‘ã‚¹ã€Œå›ºå®šã€      | ãƒ•ã‚¡ã‚¤ãƒ«ã€Œæ­£ä½“ç¢ºå®šã€       |
| å¼·ã¿     | è¦ª/å­, ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³, ãƒãƒƒã‚·ãƒ¥    | å®Ÿè¡Œæ™‚é–“ãƒ»å›æ•°, å‚ç…§ç—•è·¡ | å‰Šé™¤/ç§»å‹•å¾Œã‚‚ãƒ‘ã‚¹ç—•è·¡ | ãƒ¡ã‚¿/è­˜åˆ¥æƒ…å ±ã§åŒä¸€æ€§    |
| å¼±ã¿     | ç„¡ã„å¯èƒ½æ€§ã‚ã‚Š(æœªå°å…¥/ä¿å­˜æœŸé–“)   | ç„¡ã„=æœªå®Ÿè¡Œã§ã¯ãªã„ | å®Ÿè¡Œæ™‚åˆ»ã¨èª¤è§£ãƒªã‚¹ã‚¯   | ç’°å¢ƒ/çŠ¶æ³ã§å¯ç”¨æ€§å·® |
| å®Ÿå‹™ãƒã‚¸ã‚·ãƒ§ãƒ³ | é–‹å§‹ç‚¹(å¯èƒ½ãªã‚‰æœ€å„ªå…ˆ)       | 2ç•ªæ‰‹ã€Œå®Ÿè¡Œç¢ºèªã€     | 3ç•ªæ‰‹ã€Œå­˜åœ¨å›ºå®šã€     | 4ç•ªæ‰‹ã€ŒåŒä¸€æ€§ç¢ºå®šã€     |

---

## 7) å®Ÿæˆ¦ã‚·ãƒŠãƒªã‚ªã§ç†è§£ã™ã‚‹: ã€Œå®Ÿè¡Œå¾Œå‰Šé™¤ã€å¯¾å¿œ

### ğŸ“Œ ã‚·ãƒŠãƒªã‚ª: æ”»æ’ƒè€…ãŒ `malware.exe` ã‚’å®Ÿè¡Œå¾Œã«å‰Šé™¤ã—ã¦é€ƒèµ°

1. **Sysmon ID 1** ãŒã‚ã‚Œã°

* ã©ã®è¦ªãŒå®Ÿè¡Œã—ãŸã‹(ParentImage)
* ã©ã‚“ãªå¼•æ•°ã ã£ãŸã‹(CommandLine)
* ã©ã®ãƒãƒƒã‚·ãƒ¥ã ã£ãŸã‹(Hashes)  
  ã¾ã§ã€éª¨æ ¼ã‚’ã™ãã«ç«‹ã¦ã‚‰ã‚Œã¾ã™ã€‚

2. **Prefetch** ã§å¼·åŒ–

* `MALWARE.EXE-****.pf` ãŒæ®‹ã£ã¦ã„ã‚Œã°ã€Œå®Ÿè¡Œã€ã‚’å¼·ãç¢ºè¨¼
* å®Ÿè¡Œæ™‚é–“/å›æ•°ã§ **åå¾©å®Ÿè¡Œ** ã®æœ‰ç„¡ã¾ã§æ´ã‚ã¾ã™ã€‚

3. **ShimCache** ã§é‡˜æ‰“ã¡

* `C:\Temp\malware.exe` ã®ã‚ˆã†ãªãƒ‘ã‚¹ãŒæ®‹ã£ã¦ã„ã‚Œã°  
  ã€Œãã®ãƒ‘ã‚¹ã«å®Ÿéš›ã«å­˜åœ¨ã—ãŸã€ã“ã¨ã‚’å›ºå®šã—ã¾ã™ã€‚

4. **Amcache** ã§åŒä¸€æ€§ç¢ºå®š

* ãƒ•ã‚¡ã‚¤ãƒ«åã‚„ãƒ‘ã‚¹ãŒå¤‰ã‚ã£ãŸç—•è·¡ãŒã‚ã£ã¦ã‚‚  
  ã€Œãã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹ã€ã“ã¨ã‚’è­˜åˆ¥æƒ…å ±ã§è£œå¼·ã—ã¾ã™ã€‚

---

## 8) (ãƒ­ã‚°ãŒã‚ã‚Œã°æœ€å¼·) LOLBAS/æŒç¶šæ€§ã¾ã§ã€Œãƒã‚§ãƒ¼ãƒ³æ‹¡å¼µã€ã™ã‚‹

ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¯å¼·åŠ›ã§ã™ãŒã€**ãƒ­ã‚°ã¯ãƒã‚§ãƒ¼ãƒ³ã‚’ã‚ˆã‚Šé•·ãã€ã‚ˆã‚Šé®®æ˜ã«** ã—ã¦ãã‚Œã¾ã™ã€‚  
ç‰¹ã«LOLBASã¯ **CommandLineã¨è¦ªå­é–¢ä¿‚** ãŒæ ¸å¿ƒãªã®ã§ã€ãƒ­ã‚°é€£æºãŒéå¸¸ã«åŠ¹æœçš„ã§ã™ã€‚

### 8.1 ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã€Œã™ãçµã³ä»˜ã‘ã‚„ã™ã„ã€ãƒ­ã‚°5ç¨® (ãƒãƒ£ãƒ³ãƒãƒ«åŸºæº–)

#### 1) Sysmon: Process Create

* **ãƒãƒ£ãƒ³ãƒãƒ«**: `Applications and Services Logs > Microsoft > Windows > Sysmon > Operational`
* **ä¸»è¦ Event ID**: **1 (Process creation)**
* **çµã³ä»˜ã‘æ–¹**: `Image/CommandLine/Hashes` â†” Prefetch/ShimCache/Amcache ã‚’äº¤å·®

#### 2) ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°: ãƒ—ãƒ­ã‚»ã‚¹ç”Ÿæˆ(4688)

* **ãƒãƒ£ãƒ³ãƒãƒ«**: `Windows Logs > Security`
* **ä¸»è¦ Event ID**: **4688**
* **ãƒã‚¤ãƒ³ãƒˆ**: SysmonãŒç„¡ã„ã¨ãã«æœ€ä½é™ã®ã€Œãƒ—ãƒ­ã‚»ã‚¹ç”Ÿæˆã€æ ¹æ‹ ã‚’ç¢ºä¿  
  (ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ­ã‚®ãƒ³ã‚°ã®ãƒãƒªã‚·ãƒ¼è¨­å®šæœ‰ç„¡ã§å“è³ªãŒå·¦å³ã•ã‚Œã¾ã™ã€‚)

#### 3) PowerShell: Script Block Logging(4104)

* **ãƒãƒ£ãƒ³ãƒãƒ«**: `Microsoft > Windows > PowerShell > Operational`
* **ä¸»è¦ Event ID**: **4104**
* **ãƒã‚¤ãƒ³ãƒˆ**: LOLBAS/ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰/å®Ÿè¡Œãƒ‘ã‚¹ãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ãã®ã¾ã¾æ®‹ã‚‹ã“ã¨ãŒå¤šãã€  
  â†’ ãã®ãƒ‘ã‚¹ã‚’ShimCache/Amcacheã§å­˜åœ¨/æµå…¥ã¨ã—ã¦å›ºå®š  
  â†’ å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã¯Prefetchã§å®Ÿè¡Œç¢ºè¨¼

#### 4) TaskScheduler: ã‚¿ã‚¹ã‚¯èµ·ç‚¹ã®å®Ÿè¡Œ

* **ãƒãƒ£ãƒ³ãƒãƒ«**: `Microsoft > Windows > TaskScheduler > Operational`
* **ä¾‹ Event ID**: **200/201** ãªã©(ç’°å¢ƒã«ã‚ˆã‚Šç•°ãªã‚‹)
* **ãƒã‚¤ãƒ³ãƒˆ**: æŒç¶šæ€§(ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ã‚¹ã‚¯)ã¨ã—ã¦ã€Œå†å®Ÿè¡Œã•ã›ã‚‹ãƒˆãƒªã‚¬ãƒ¼ã€ã‚’æ‰ãˆã‚„ã™ã„

#### 5) WMI Activity: WMIèµ·ç‚¹ã®å®Ÿè¡Œ/æŒç¶šæ€§ã®æ‰‹æ›ã‹ã‚Š

* **ãƒãƒ£ãƒ³ãƒãƒ«**: `Microsoft > Windows > WMI-Activity > Operational`
* **ä»£è¡¨çš„ãª Event ID ç¾¤**: **5857~5861** ãªã©(ç’°å¢ƒã«ã‚ˆã‚Šç•°ãªã‚‹)
* **ãƒã‚¤ãƒ³ãƒˆ**: WMIã«ã‚ˆã‚‹å®Ÿè¡Œ/æŒç¶šæ€§ã¯ç—•è·¡ãŒã€Œãƒ­ã‚°å´ã€ã«æ®‹ã‚Šã‚„ã™ãã€ç´ä»˜ã‘ä¾¡å€¤ãŒé«˜ã„

---

## 9) æœ€å¾Œã®ãƒ‘ã‚ºãƒ«: ã€Œèª°ãŒå†ã³å‹•ã‹ã—ãŸã®ã‹ã€ (æŒç¶šæ€§ãƒˆãƒªã‚¬ãƒ¼)

åˆå›å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã¨ **å†å®Ÿè¡Œ(æŒç¶šæ€§)ãƒˆãƒªã‚¬ãƒ¼** ã¯åˆ¥ã§ã‚ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚  
ãã®ãŸã‚å®Ÿè¡Œãƒã‚§ãƒ¼ãƒ³ã®çµ‚ç‚¹ã¯ãŸã„ã¦ã„ã“ã“ã«å‘ã‹ã„ã¾ã™ã€‚

* Scheduled Tasks (schtasks)
* Services (ã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²)
* WMIã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­(æ°¸ç¶šè³¼èª­)

ğŸ“Œ å®Ÿå‹™ãƒ’ãƒ³ãƒˆ

> ã€Œåˆå›å®Ÿè¡Œ(åˆæœŸä¾µå…¥)ãƒã‚§ãƒ¼ãƒ³ã€ã¨ã€Œå†å®Ÿè¡Œ(æŒç¶šæ€§)ãƒã‚§ãƒ¼ãƒ³ã€ã‚’ **åˆ†é›¢** ã—ã¦æãã¨ã€ãƒ¬ãƒãƒ¼ãƒˆãŒã¯ã‚‹ã‹ã«æ˜ç¢ºã«ãªã‚Šã¾ã™ã€‚

---

## 10) PrefetchãŒç„¡ã„/å¼±ã„ã¨ã: ã€Œç„¡ã„ = å®Ÿè¡Œã—ã¦ã„ãªã„ã€ç¦æ­¢

PrefetchãŒç©ºã«ãªã‚Šå¾—ã‚‹ç†ç”±ã¯ã‹ãªã‚Šå¤šã„ã§ã™ã€‚

* ãƒãƒªã‚·ãƒ¼/ç’°å¢ƒã«ã‚ˆã‚ŠPrefetchç„¡åŠ¹
* ä¿å­˜æ•°åˆ¶é™ã«ã‚ˆã‚‹ä¸Šæ›¸ã
* æ”»æ’ƒè€…ã«ã‚ˆã‚‹å‰Šé™¤
* ã‚µãƒ¼ãƒ/ç‰¹æ®Šæ§‹æˆ

ãã®ãŸã‚PrefetchãŒç„¡ã„å ´åˆã¯ã€

* ShimCache/Amcacheã§å­˜åœ¨ãƒ»æ­£ä½“ã‚’è£œå¼·ã—
* (å¯èƒ½ãªã‚‰)ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã§å®Ÿè¡Œã‚’è£œå¼·ã—
* ãã‚Œã§ã‚‚ä¸è¶³ãªã‚‰MFT/USNã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã¸æ‹¡å¼µã—ã¾ã™ã€‚

---

## 11) ãƒ¬ãƒãƒ¼ãƒˆã«ã“ã†æ›¸ã‘ã°æºã‚‰ãã¾ã›ã‚“ (æ ¹æ‹ ã‚»ãƒƒãƒˆ)

ãƒ¬ãƒãƒ¼ãƒˆã§æœ€ã‚‚æºã‚‰ãç¬é–“ã¯ã“ã‚Œã§ã™ã€‚

* ã€Œå®Ÿè¡Œã•ã‚ŒãŸæ°—ãŒã—ã¾ã™ã€ â†’ æ ¹æ‹ ãŒå¼±ã„ã¨ã™ãåè«–ã•ã‚Œã‚‹
* ã€Œæ‚ªæ€§ã§ã™ã€ â†’ åŒä¸€æ€§(ãƒãƒƒã‚·ãƒ¥/è­˜åˆ¥)ãŒç„¡ã„ã¨è­°è«–ã«ç™ºå±•ã™ã‚‹

ãã®ãŸã‚ãƒ¬ãƒãƒ¼ãƒˆæ–‡ã¯å¯èƒ½ãªé™ã‚Š **ã‚»ãƒƒãƒˆ** ã§æ›¸ãã¾ã™ã€‚

* **ãƒã‚§ãƒ¼ãƒ³**: Parent â†’ Child
* **æ™‚é–“**: å®Ÿè¡Œæ™‚é–“(ãƒ­ã‚°/Prefetch)
* **ãƒ‘ã‚¹**: Full Path(ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆäº¤å·®)
* **åŒä¸€æ€§**: Hash/è­˜åˆ¥(å¯èƒ½ãªã‚‰Amcache/Sysmon)

ä¾‹æ–‡(ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ)

> (æ™‚é–“) ã« (è¦ªãƒ—ãƒ­ã‚»ã‚¹) ãŒ (ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³) ã§ (å­ãƒ—ãƒ­ã‚»ã‚¹) ã‚’å®Ÿè¡Œã—ã€  
> Prefetchã§å®Ÿè¡Œç—•è·¡(å›æ•°/æ™‚é–“)ãŒç¢ºèªã•ã‚Œã€ShimCacheã§å½“è©²ãƒ‘ã‚¹ã®å­˜åœ¨ãŒç¢ºèªã•ã‚Œã€  
> Amcache/Sysmonãƒãƒƒã‚·ãƒ¥ã§åŒä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹ã“ã¨ã‚’äº¤å·®æ¤œè¨¼ã—ãŸã€‚  

---

## 12) ç¾å ´ã§ãã®ã¾ã¾ä½¿ãˆã‚‹ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ (10å•10ç­”)

1ï¸âƒ£ **ä»Šã¤ã‹ã‚“ã æ‰‹æ›ã‹ã‚Šã¯ã€Œå®Ÿè¡Œ(ãƒ­ã‚°)ã€ã‹ã€Œãƒ•ã‚¡ã‚¤ãƒ«(ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ)ã€ã‹ï¼Ÿ**  
â†’ åˆ†æã®é–‹å§‹ç‚¹ã‚’æ­£ç¢ºã«å®šç¾©ã—ã¦ã“ãã€èª¿æŸ»å·¥ç¨‹ã®ç„¡é§„ã‚’æœ€å°åŒ–ã§ãã¾ã™ã€‚  
â†’ ãƒ­ã‚°ãªã‚‰Sysmonã‹ã‚‰ã€ãƒ•ã‚¡ã‚¤ãƒ«ãªã‚‰Prefetch/ShimCacheã‹ã‚‰ã€‚

2ï¸âƒ£ **èª°ãŒå®Ÿè¡Œã—ãŸã‹(è¦ªãƒ—ãƒ­ã‚»ã‚¹)?**   
â†’ Sysmon ID 1 ã® `ParentImage`  

3ï¸âƒ£ **ä½•ãŒå®Ÿè¡Œã•ã‚ŒãŸã‹(æ­£ç¢ºãªãƒ‘ã‚¹)?**   
â†’ Sysmon `Image` â†” Prefetch/ShimCache ãƒ‘ã‚¹äº¤å·®  

4ï¸âƒ£ **æœ¬å½“ã«å®Ÿè¡Œã•ã‚ŒãŸã‹(ãƒ­ã‚°ãŒä¸å®Œå…¨ã§ã‚‚)?**   
â†’ Prefetch `.pf` ã®å­˜åœ¨ã§å®Ÿè¡Œæ ¹æ‹ ã‚’å¼·åŒ–  

5ï¸âƒ£ **ã„ã¤å®Ÿè¡Œã•ã‚ŒãŸã‹?**   
â†’ Prefetchå®Ÿè¡Œæ™‚åˆ» + Sysmonã‚¤ãƒ™ãƒ³ãƒˆæ™‚åˆ»ã§ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å›ºå®š  

6ï¸âƒ£ **ä½•å›å®Ÿè¡Œã•ã‚ŒãŸã‹(åå¾©/æŒç¶šã®æœ‰ç„¡)?**   
â†’ Prefetch `Run Count`  

7ï¸âƒ£ **ãã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚·ã‚¹ãƒ†ãƒ ã«ã€Œå­˜åœ¨ã—ãŸã€ã“ã¨ã¯ç¢ºå®Ÿã‹?**   
â†’ ShimCacheã§å­˜åœ¨/ãƒ‘ã‚¹å›ºå®š  

8ï¸âƒ£ **ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã€åå‰ã ã‘å¤‰ãˆãŸã®ã§ã¯ï¼Ÿ åŒä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã‹?**   
â†’ Amcache(è­˜åˆ¥/ãƒãƒƒã‚·ãƒ¥)ã§åŒä¸€æ€§ç¢ºå®š  

9ï¸âƒ£ **LOLBAS/ã‚¹ã‚¯ãƒªãƒ—ãƒˆå›é¿å®Ÿè¡Œã®ç—•è·¡ã¯?**   
â†’ Sysmon CommandLine + PowerShell(4104)/Task/WMIãƒ­ã‚°é€£æº  

ğŸ”Ÿ **ãƒ¬ãƒãƒ¼ãƒˆã§æºã‚‰ãŒãªã„æ ¹æ‹ ã‚»ãƒƒãƒˆã¯?**   
â†’ ãƒã‚§ãƒ¼ãƒ³(è¦ªâ†’å­) + æ™‚é–“ + ãƒ‘ã‚¹ + åŒä¸€æ€§(ãƒãƒƒã‚·ãƒ¥)

---

## å‚è€ƒãƒªãƒ³ã‚¯

[1]: https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon "Sysmon - Sysinternals (Microsoft Learn)"
[2]: https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4688 "4688(S) A new process has been created (Microsoft Learn)"
[3]: https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/component-updates/command-line-process-auditing "Command line process auditing (Microsoft Learn)"
[4]: https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_logging_windows?view=powershell-7.5 "about_Logging_Windows - PowerShell (Microsoft Learn)"
[5]: https://research.splunk.com/endpoint/b3632472-310b-11ec-9aab-acde48001122/ "WinEvent Windows Task Scheduler Event Action Started (Splunk Research)"
[6]: https://docs.nxlog.co/integrate/wmi.html "Windows Management Instrumentation (WMI) (NXLog Documentation)"
[7]: https://redcanary.com/threat-detection-report/techniques/windows-management-instrumentation/ "Windows Management Instrumentation (Red Canary)"
[8]: https://lolbas-project.github.io/ "LOLBAS Project"
